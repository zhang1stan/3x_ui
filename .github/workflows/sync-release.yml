name: 自动同步原厂 Release

on:
  schedule:
    - cron: '0 6 * * *' # 每天北京时间 14:00 自动检查
  workflow_dispatch:    # 支持手动点击按钮触发

permissions:
  contents: write      # 允许发布 Release 和推送代码
  workflows: write     # 【关键新增】允许同步包含工作流文件的标签

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 检查并同步
        env:
          GH_TOKEN: ${{ github.token }}
          UPSTREAM_REPO: "MHSanaei/3x-ui" # 原作者仓库
        run: |
          # 1. 获取原仓库最新版本号
          LATEST_TAG=$(gh release view --repo $UPSTREAM_REPO --json tagName --template '{{.tagName}}')
          echo "最新版本: $LATEST_TAG"

          # 2. 如果本地已存在该版本，直接退出
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            echo "版本已是最新，跳过。"
            exit 0
          fi

          # 3. 移除旧的远程库并添加新的
          git remote remove upstream || true
          git remote add upstream https://github.com/$UPSTREAM_REPO.git
          
          # 4. 抓取所有标签并强制同步
          git fetch upstream --tags
          git push origin --tags --force

          # 5. 下载所有发行版附件
          mkdir -p ./downloads
          gh release download $LATEST_TAG --repo $UPSTREAM_REPO --dir ./downloads

          # 6. 获取发布内容
          TITLE=$(gh release view $LATEST_TAG --repo $UPSTREAM_REPO --json name --template '{{.name}}')
          BODY=$(gh release view $LATEST_TAG --repo $UPSTREAM_REPO --json body --template '{{.body}}')

          # 7. 在你的仓库创建 Release
          gh release create $LATEST_TAG ./downloads/* --title "$TITLE" --notes "$BODY" || echo "Release 已存在。"
